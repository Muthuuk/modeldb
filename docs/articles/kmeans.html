<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K Means models • modeldb</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../tidyverse-2.css" rel="stylesheet">
<meta property="og:title" content="K Means models">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- google analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-115082821-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">modeldb</a>
        <div class="info">
          <span class="partof">part of <a href="https://github.com/tidymodels">tidymodels</a></span>
          <span class="version version-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.1</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/kmeans.html">K Means models</a>
    </li>
    <li>
      <a href="../articles/linear-regression.html">Linear regression models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/tidymodels/modeldb">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>K Means models</h1>
                        <h4 class="author">Edgar Ruiz</h4>
            
            <h4 class="date">2020-02-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/modeldb/blob/master/vignettes/kmeans.Rmd"><code>vignettes/kmeans.Rmd</code></a></small>
      <div class="hidden name"><code>kmeans.Rmd</code></div>

    </div>

    
    
<div id="intro" class="section level2">
<h2 class="hasAnchor">
<a href="#intro" class="anchor"></a>Intro</h2>
<p>The <code><a href="../reference/simple_kmeans_db.html">simple_kmeans_db()</a></code> function enables running the KMeans model inside the database. It uses <code>dplyr</code> programming to abstract the steps needed produce a model, so that it can then be translated into SQL statements in the background.</p>
</div>
<div id="example-setup" class="section level2">
<h2 class="hasAnchor">
<a href="#example-setup" class="anchor"></a>Example setup</h2>
<p>In this example, a simple <code>RSQlite</code> database will be use to load the <code>flights</code> data from the <code>nycflights13</code> library.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span>(RSQLite<span class="op">::</span><span class="kw"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span>(), <span class="dt">path =</span> <span class="st">":memory:"</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">RSQLite<span class="op">::</span><span class="kw"><a href="https://rsqlite.r-dbi.org/reference/initExtension.html">initExtension</a></span>(con)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">db_flights &lt;-<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/copy_to.html">copy_to</a></span>(con, nycflights13<span class="op">::</span>flights, <span class="st">"flights"</span>)</a></code></pre></div>
</div>
<div id="running-kmeans-clustering" class="section level2">
<h2 class="hasAnchor">
<a href="#running-kmeans-clustering" class="anchor"></a>Running Kmeans clustering</h2>
<p>The function <code><a href="../reference/simple_kmeans_db.html">simple_kmeans_db()</a></code> can use with local data, or a remote table, such as the <code>db_flights</code> variable that is a pointer to the “flights” table inside the SQLite database. When piping to the function, the only other required arguments are two or more fields separated by comma. Because it uses ‘tidyeval’, the variable name auto-completion will work.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(modeldb)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">km &lt;-<span class="st"> </span>db_flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../reference/simple_kmeans_db.html">simple_kmeans_db</a></span>(dep_time, distance)</a></code></pre></div>
<p>The <code><a href="../reference/simple_kmeans_db.html">simple_kmeans_db()</a></code> function uses a progress bar to show you the current cycle, the maximum cycles it’s expected to run, the current difference between the previous cycle and the current cycle, and the running time. The loop will stop once it wither has two matching consecutive cycles, or if it reaches the maximum number of cycles, as determined by the <code>max_repeats</code> argument.</p>
<p>The final <strong>centers</strong> are are stored in the <code>centers</code> variable of the returned object</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">km<span class="op">$</span>centers</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; NULL</span></a></code></pre></div>
<p>The latest results are stored in the <code>tbl</code> variable of the returned object. The type of the returned table will match the type of the original source, so if it is a remote source, such as database table, then <code>tbl</code> will be a class <code>tbl_sql</code>. This will allow us to do two thing:</p>
<ul>
<li>View the SQL statement that was used to find the final centers:</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">dbplyr<span class="op">::</span><span class="kw"><a href="https://dbplyr.tidyverse.org/reference/remote_name.html">remote_query</a></span>(km)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt; &lt;SQL&gt; SELECT `RHS`.`center` AS `k_center`, `LHS`.`k_dep_time` AS `k_dep_time`, `LHS`.`k_distance` AS `k_distance`, `RHS`.`year` AS `year`, `RHS`.`month` AS `month`, `RHS`.`day` AS `day`, `RHS`.`dep_time` AS `dep_time`, `RHS`.`sched_dep_time` AS `sched_dep_time`, `RHS`.`dep_delay` AS `dep_delay`, `RHS`.`arr_time` AS `arr_time`, `RHS`.`sched_arr_time` AS `sched_arr_time`, `RHS`.`arr_delay` AS `arr_delay`, `RHS`.`carrier` AS `carrier`, `RHS`.`flight` AS `flight`, `RHS`.`tailnum` AS `tailnum`, `RHS`.`origin` AS `origin`, `RHS`.`dest` AS `dest`, `RHS`.`air_time` AS `air_time`, `RHS`.`distance` AS `distance`, `RHS`.`hour` AS `hour`, `RHS`.`minute` AS `minute`, `RHS`.`time_hour` AS `time_hour`</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#&gt; FROM (SELECT `center` AS `k_center`, `dep_time` AS `k_dep_time`, `distance` AS `k_distance`</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; FROM (SELECT `center`, AVG(`dep_time`) AS `dep_time`, AVG(`distance`) AS `distance`</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt; FROM (SELECT `dep_time`, `distance`, `center`</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt; FROM (SELECT *</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt; FROM (SELECT `year`, `month`, `day`, `dep_time`, `sched_dep_time`, `dep_delay`, `arr_time`, `sched_arr_time`, `arr_delay`, `carrier`, `flight`, `tailnum`, `origin`, `dest`, `air_time`, `distance`, `hour`, `minute`, `time_hour`, `center_1`, `center_2`, `center_3`, CASE</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt; WHEN (`center_1` &gt;= `center_1` AND `center_1` &lt; `center_2` AND `center_1` &lt; `center_3`) THEN ('center_1')</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#&gt; WHEN (`center_2` &lt; `center_1` AND `center_2` &gt;= `center_2` AND `center_2` &lt; `center_3`) THEN ('center_2')</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt; WHEN (`center_3` &lt; `center_1` AND `center_3` &lt; `center_2` AND `center_3` &gt;= `center_3`) THEN ('center_3')</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt; </span><span class="re">END</span><span class="co"> AS `center`</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">#&gt; FROM (SELECT `year`, `month`, `day`, `dep_time`, `sched_dep_time`, `dep_delay`, `arr_time`, `sched_arr_time`, `arr_delay`, `carrier`, `flight`, `tailnum`, `origin`, `dest`, `air_time`, `distance`, `hour`, `minute`, `time_hour`, SQRT(((889.757881651311 - `dep_time`) * (889.757881651311 - `dep_time`)) + ((791.286862996562 - `distance`) * (791.286862996562 - `distance`))) AS `center_1`, SQRT(((1391.08534916316 - `dep_time`) * (1391.08534916316 - `dep_time`)) + ((2355.04462033144 - `distance`) * (2355.04462033144 - `distance`))) AS `center_2`, SQRT(((1745.74853136521 - `dep_time`) * (1745.74853136521 - `dep_time`)) + ((718.043515631104 - `distance`) * (718.043515631104 - `distance`))) AS `center_3`</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt; FROM `flights`))</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co">#&gt; WHERE (NOT(((`center`) IS NULL)))))</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#&gt; GROUP BY `center`)) AS `LHS`</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co">#&gt; RIGHT JOIN (SELECT `year`, `month`, `day`, `dep_time`, `sched_dep_time`, `dep_delay`, `arr_time`, `sched_arr_time`, `arr_delay`, `carrier`, `flight`, `tailnum`, `origin`, `dest`, `air_time`, `distance`, `hour`, `minute`, `time_hour`, `center`</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#&gt; FROM (SELECT `year`, `month`, `day`, `dep_time`, `sched_dep_time`, `dep_delay`, `arr_time`, `sched_arr_time`, `arr_delay`, `carrier`, `flight`, `tailnum`, `origin`, `dest`, `air_time`, `distance`, `hour`, `minute`, `time_hour`, `center_1`, `center_2`, `center_3`, CASE</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#&gt; WHEN (`center_1` &gt;= `center_1` AND `center_1` &lt; `center_2` AND `center_1` &lt; `center_3`) THEN ('center_1')</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt; WHEN (`center_2` &lt; `center_1` AND `center_2` &gt;= `center_2` AND `center_2` &lt; `center_3`) THEN ('center_2')</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co">#&gt; WHEN (`center_3` &lt; `center_1` AND `center_3` &lt; `center_2` AND `center_3` &gt;= `center_3`) THEN ('center_3')</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="co">#&gt; </span><span class="re">END</span><span class="co"> AS `center`</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="co">#&gt; FROM (SELECT `year`, `month`, `day`, `dep_time`, `sched_dep_time`, `dep_delay`, `arr_time`, `sched_arr_time`, `arr_delay`, `carrier`, `flight`, `tailnum`, `origin`, `dest`, `air_time`, `distance`, `hour`, `minute`, `time_hour`, SQRT(((889.757881651311 - `dep_time`) * (889.757881651311 - `dep_time`)) + ((791.286862996562 - `distance`) * (791.286862996562 - `distance`))) AS `center_1`, SQRT(((1391.08534916316 - `dep_time`) * (1391.08534916316 - `dep_time`)) + ((2355.04462033144 - `distance`) * (2355.04462033144 - `distance`))) AS `center_2`, SQRT(((1745.74853136521 - `dep_time`) * (1745.74853136521 - `dep_time`)) + ((718.043515631104 - `distance`) * (718.043515631104 - `distance`))) AS `center_3`</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co">#&gt; FROM `flights`))</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="co">#&gt; WHERE (NOT(((`center`) IS NULL)))) AS `RHS`</span></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="co">#&gt; ON (`LHS`.`k_center` = `RHS`.`center`)</span></a></code></pre></div>
</div>
<div id="under-the-hood" class="section level2">
<h2 class="hasAnchor">
<a href="#under-the-hood" class="anchor"></a>Under the hood</h2>
<p>The <code><a href="../reference/simple_kmeans_db.html">simple_kmeans_db()</a></code> function uses <code>dplyr</code> and ‘tidyeval’ to run the KMeans algorithm. This means that when combined with <code>dbplyr</code>, the routines can be run inside a database.</p>
<p>Unlike other packages that use this same methodology, such as <code>dbplot</code> and <code>tidypredict</code>, <code><a href="../reference/simple_kmeans_db.html">simple_kmeans_db()</a></code> does not create a single <code>dplyr</code> code that can be extracted as SQL. The function produces multiple, serial and dependent SQL statements that run individually inside the database. Each statement uses the current <em>centroids</em>, or centers, to estimate new centroids, and then it uses those centroids in a consecutive SQL statement to see if there was any variance. Effectively, this approach uses R not only as translation layer, but also as an orchestration layer.</p>
</div>
<div id="safeguards-for-long-running-jobs" class="section level2">
<h2 class="hasAnchor">
<a href="#safeguards-for-long-running-jobs" class="anchor"></a>Safeguards for long running jobs</h2>
<p>The<code><a href="../reference/simple_kmeans_db.html">simple_kmeans_db()</a></code> approach of using multiple and consecutive SQL queries to find the optimal centers, additionally, in KMeans clustering, it matters the order in which the each set of centers is passed. This creates an imperative to find a way to cache the current centers used in a long running job, in case the job is canceled or fails. Starting from the centers that were calculated last, will mean that re-starting the job will not being from “0”, but from a more advanced, read closer, set of centers.</p>
<p>The safeguard implemented in this function is trough a file, called <em>kmeans.csv</em>. Each cycle will update the file. The file name can be changed by modifying the <code>safeguard_file</code> argument. Setting the argument to NULL will turn off the safeguard. The file will be saved to the temporary directory of the R session..</p>
<p>In this example we will set the <code>max_repats</code> to 10, so as to artificially avoid finding the optimal means</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">km &lt;-<span class="st"> </span>db_flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/simple_kmeans_db.html">simple_kmeans_db</a></span>(dep_time, distance, <span class="dt">max_repeats =</span> <span class="dv">10</span>)</a></code></pre></div>
<p>In the next run, the “kmeans.csv” file is passed as the <code>initial_kmeans</code> argument. This will make <code><a href="../reference/simple_kmeans_db.html">simple_kmeans_db()</a></code> use those centers as the starting point:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">km &lt;-<span class="st"> </span>db_flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/simple_kmeans_db.html">simple_kmeans_db</a></span>(dep_time, distance, <span class="dt">initial_kmeans =</span> <span class="kw"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"kmeans.csv"</span>)))</a></code></pre></div>
<p>The second run took 7 cycles to complete, which adds up to the 17 cycles that it initially took in the first example at the top of this article.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#intro">Intro</a></li>
      <li><a href="#example-setup">Example setup</a></li>
      <li><a href="#running-kmeans-clustering">Running Kmeans clustering</a></li>
      <li><a href="#under-the-hood">Under the hood</a></li>
      <li><a href="#safeguards-for-long-running-jobs">Safeguards for long running jobs</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="tidyverse">
  <p><code>modeldb</code> is a part of the <strong>tidymodels</strong> ecosystem, a collection of modeling packages designed with common APIs and a shared philosophy.</p>
</div>

<div class="author">
  <p>
    Developed by Edgar Ruiz.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
